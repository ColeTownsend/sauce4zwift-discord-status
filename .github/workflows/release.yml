name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build executables
        run: npm run build:all

      - name: Create release package
        run: |
          # Create release directory structure
          mkdir -p release-package
          cp -r src package.json manifest.json LICENSE README.md release-package/
          cp installer-macos.sh installer-windows.bat release-package/
          chmod +x release-package/installer-macos.sh

          # Create ZIP for installer package
          cd release-package
          zip -r ../sauce4zwift-discord-status-installer.zip .
          cd ..

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            sauce4zwift-discord-status-installer.zip
            dist/sauce4zwift-discord-status-macos
            dist/sauce4zwift-discord-status-win.exe
            dist/sauce4zwift-discord-status-linux
          body: |
            ## Installation Options

            ### Option 1: Auto-Installer (Recommended)

            **Installs as a Sauce4Zwift mod!**

            1. Download `sauce4zwift-discord-status-installer.zip`
            2. Extract the ZIP file
            3. Run the installer:
               - **macOS**: Double-click `installer-macos.sh`
               - **Windows**: Double-click `installer-windows.bat`

            The installer automatically:
            - Creates `~/Documents/SauceMods` directory
            - Installs the mod to the correct location
            - Sets up all dependencies
            - Creates a launch shortcut

            ### Option 2: Standalone Executable

            **No installation or configuration needed!**

            1. Download the executable for your platform:
               - **macOS**: `sauce4zwift-discord-status-macos`
               - **Windows**: `sauce4zwift-discord-status-win.exe`
               - **Linux**: `sauce4zwift-discord-status-linux`
            2. Double-click to run!

            ---

            Make sure Discord and Sauce4Zwift are running before you start!
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
